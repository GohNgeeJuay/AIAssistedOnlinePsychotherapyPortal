<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Uploading Media</title>
    <!-- Bootstrap CSS -->
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous"></head>
</head>
<body>
    <div>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Online Psychotherapy Portal</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" aria-current="page" href="/">Home</a>
                    <a class="nav-link" href="/videoDb">Videos Database</a>
                    <a class="nav-link active" href="/upload">Upload</a>
                </div>
                </div>
            </div>
        </nav>
    </div>
    <div class="container mt-5">
        <div class="row">
            <div class="alert alert-success d-none" id="successAlert" role="alert">
                    <span id="successMsg"></span> Click <a href="/videoDb" class="alert-link">here to go to the Video Database</a>
            </div>
            <div class="alert alert-danger d-none" id="dangerAlert" role="alert">
                Please try upload your video again!
            </div>
            <div class="col d-flex justify-content-center">
                <div class="card  w-50">
                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                                <h2>Upload Video</h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="d-flex justify-content-center d-none" id="spinner"> 
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <form id="uploadForm" class="form">
                                    <div class="row mt-3">
                                        <div class="col">
                                            <input id="videoInput" type="file" name="videoFile" class="form-control" accept="video/*" required/>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col  d-flex justify-content-center">
                                            <button type="submit" class="btn btn-primary ">Upload your video file</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                
    {% if video is defined %}
        <video controls>
            <source src="/static/uploads/{{video}}"></source>
        </video>
    {% endif %}

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script>
        // collect all the elements     
        let spinner = document.getElementById("spinner");
        let form = document.getElementById("uploadForm");
        let successAlert = document.getElementById("successAlert");
        let dangerAlert = document.getElementById("dangerAlert");
        
        
        const submitVideo = (event) => {
            // prevents user to refresh page         
            event.preventDefault();
            spinner.classList.toggle('d-none');
            form.classList.toggle('d-none');
            
            let formData = new FormData(form);
            
            fetch("/upload", {
                method: "POST",
                body: formData
            }).then((response) => {
                // Over here it is a Readable Stream 
                // The response is a Response instance.
                // You parse the data into a useable format using `.json()`
                return response.json();
            })
            .then((response) => {
                // response here is a JS object
                spinner.classList.toggle('d-none');
                form.classList.toggle('d-none');
                form.reset();

                let successMsgEl = document.getElementById("successMsg");
                successMsgEl.textContent = response.message;

                if (successAlert.classList.contains('d-none')) {
                    successAlert.classList.toggle('d-none');
                }

                
                if (!dangerAlert.classList.contains('d-none')) {
                    dangerAlert.classList.toggle('d-none');
                }

            }).catch((error) => {

                spinner.classList.toggle('d-none');
                form.classList.toggle('d-none');
                
                if (!successAlert.classList.contains('d-none')) {
                    successAlert.classList.toggle('d-none');
                }

                if (dangerAlert.classList.contains('d-none')) {
                    dangerAlert.classList.toggle('d-none');
                }
                console.log(error)
            })
        }

        form.addEventListener('submit', submitVideo)
    </script>
</body>
</html>